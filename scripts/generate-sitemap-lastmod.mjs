import { execSync } from "node:child_process"
import { mkdirSync, writeFileSync } from "node:fs"
import { dirname } from "node:path"
import { fileURLToPath } from "node:url"

const ROUTE_TO_SOURCE = [
  { path: "/", file: "app/routes/home.tsx" },
  { path: "/privacy-policy", file: "app/routes/privacy-policy.tsx" },
  { path: "/tos", file: "app/routes/tos.tsx" },
]

function getGitLastModified(file) {
  try {
    const output = execSync(`git log -1 --format=%cI -- "${file}"`, {
      encoding: "utf8",
      stdio: ["ignore", "pipe", "ignore"],
    }).trim()
    return output || null
  } catch {
    return null
  }
}

const map = {}
for (const route of ROUTE_TO_SOURCE) {
  const lastModified = getGitLastModified(route.file)
  if (lastModified) {
    map[route.path] = lastModified
  }
}

const generatedSource = `// This file is auto-generated by scripts/generate-sitemap-lastmod.mjs
// Do not edit manually.

export const sitemapLastmodMap: Record<string, string> = ${JSON.stringify(map, null, 2)}
`

const thisFilePath = fileURLToPath(import.meta.url)
const projectRoot = dirname(dirname(thisFilePath))
const outputPath = `${projectRoot}/app/data/sitemap-lastmod.generated.ts`

mkdirSync(dirname(outputPath), { recursive: true })
writeFileSync(outputPath, generatedSource, "utf8")

console.log(`Generated ${outputPath}`)
